<!DOCTYPE html>
<html>
    <head>
        <title>观察者模式3-1</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <style>
            .title {
                font-weight: bold;
                font-size: 18px;
                padding: 15px;
            }
            .container{
                width: 400px;
				height:400px;
                font-size: 12px;
				border: 3px solid #000000;
            }
        </style>
    </head>
    <body>
        <section>
            <div class="title">发件人</div>
            <div class="btn-group">
                <button id="triggre">发布邮件</button>
                <button id="triggre-offline">发布离线邮件</button>
            </div>
            <br>
            <div class="container">
                    <h2>订阅者:</h2>
                    <ul id="listener"></ul>
            </div>
        </section>
       
        <script>
            var Event = function () {
            var clientList = {}
            var cache = {}

            this.listen = function (key, cb) {
                if(cache[key] && cache[key].length) {
                    var _this = this
                    cache[key].forEach(function (args) {
                        cb.apply(_this, args)
                    })
                    cache[key] = []
                }
                clientList[key] = clientList[key] || []
                clientList[key].push(cb)
            }

            this.one = function (key, cb) {
                var fn = function () {
                    cb.apply(this, arguments)
                    this.remove(key, fn)
                }
                clientList[key] = clientList[key] || []
                clientList[key].push(fn)
            }

            this.remove = function (key, cb) {
                var fns = clientList[key]
                if(!cb) {
                    clientList[key] = []
                }else if(fns && fns.length) {
                    clientList[key] = fns.filter(fn => fn !== cb)
                }
            }

            this.trigger = function () {
                var key = Array.prototype.shift.call(arguments)
                var args = arguments
                var fns = clientList[key]
                var _this = this

                if(fns && fns.length) {
                    fns.forEach(function(fn) {
                        fn.apply(_this, args)
                    })
                } else { // 保存没有订阅者的事件，派发给以后的订阅者
                    var list = cache[key] || []
                    list.push(args)
                    cache[key] = list
                    console.log('key', key, cache[key]);

                }
            }
        }

        // 使用事件模式
        var event = new Event()
        var appendLi = function (parent, text) {
            var li = document.createElement('li')
            li.innerText = text
            parent.appendChild(li)
        }

        event.listen('event', function () {
            appendLi(document.getElementById('listener'), '接收到成绩单。')
        })

        document.getElementById('triggre').onclick = function () {
            event.trigger('event', '发送成绩单~')
        }

        </script>
    </body>
</html>